name: "CI and Documentation"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ===================================
  # Run Tests, Pre-Commit, and Coverage
  # ===================================
  tests:
    runs-on: ubuntu-latest
    name: Run tests and code coverage
    steps:
      # Setup Python
      # ===============================
      - name: Setup Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"
          architecture: "x64"
          cache: "pip"

      # Install pyembree
      - name: Install pyembree
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev debhelper build-essential libembree-dev libtbb-dev
          wget https://github.com/embree/embree/releases/download/v2.17.7/embree-2.17.7.x86_64.linux.tar.gz
          tar -xzvf embree-2.17.7.x86_64.linux.tar.gz
          source embree-2.17.7.x86_64.linux/embree-vars.sh
          git clone git@github.com:scopatz/pyembree.git
          cd pyembree
          pip install Cython
          pip install .
          cd ..

      # Run Pytest
      # ===============================
      - name: Run Pytest
        run: |
          pip install pytest
          pip install pytest-timeout
          pytest --timeout 60

